## 第一阶段
FastAPI（所有后端模块）
PostgreSQL + pgvector
Redis
RabbitMQ
MinIO（或 S3）
Nginx
Prometheus + Grafana
（日志先 stdout + 文件，后面再接 Loki/ELK）

### 架构分层
1.Experience Layer（体验层）
- ainern2d-studio-web (Vue3)
2.Control Layer（控制/编排层）
- gateway（API 入口）
- orchestrator（状态机 / DAG）
- worker-hub（执行控制面）
3.Intelligence Layer（智能决策层）
- entity-core
- asset-knowledge
- planner
- model-router
4.Execution Layer（执行层）
- worker-video
- worker-audio
- worker-llm
- worker-lipsync
- composer
5.Data & Knowledge Layer（数据与知识层）
- PostgreSQL（业务数据）
- pgvector（向量检索）
- Redis（缓存/短状态）
- RabbitMQ（队列/事件）
- MinIO/S3（产物与素材）
6.Platform Layer（平台基础设施层）
- Docker / Docker Compose（当前）
- Nginx / Traefik
- Prometheus / Grafana / Loki / Tempo（后续）
- CI/CD（GitHub Actions / GitLab CI）
- 机房/云资源、GPU 节点、域名、证书等
- 当前分2台机器部署一台CPU 一台GPU
- 
#### 模块名称:
Gateway（入口网关）
Orchestrator（编排器）
Entity Core（实体核心）
Asset Knowledge（素材知识库）
Planner（规划器）
Model Router（模型路由器）
Worker Hub（执行中枢）
Worker Video / Audio / LLM / LipSync（执行器）
Composer（合成器）
Observer（观测中心）
Contracts（通信契约）
Telemetry（节点遥测）
Artifacts（产物）
Run / Job / Stage / Event / Artifact（运行对象命名）

### 共享包：
#### ainern2d-contracts
里面放：
- TaskSpec
- DispatchDecision
- EntityPack
- AssetCandidate
- ShotPlan
- TimelinePlan
- ArtifactMeta
- WorkerResult
- EventEnvelope
- ErrorCode
这些是 服务通信契约
每个服务自己维护：
自己的 ORM 模型
自己的表结构
自己的 Alembic migrations
例如：
orchestrator 有 render_runs, jobs, workflow_events
entity-core 有 entity_records, entity_links
planner 有 plans, timeline_segments, task_dags
即使有重复概念，也没关系（通过契约连接）。


### 中间价
中间件（建议一开始就有）
1) PostgreSQL + pgvector）
用途：
素材检索
风格/角色/场景相似度检索
RAG 检索
哪些模块用：
asset-knowledge（核心）
entity-core（辅助检索）
planner（拿候选素材时用）
用途：
任务、运行记录、状态机、产物元数据、实体结构化结果、计划结果
核心业务数据库
哪些模块用：
gateway（少量读写）
orchestrator（重度）
entity-core（读写）
planner（读写）
model-router（读少写少）
worker-hub（状态回写）
composer（结果回写）
observer（统计来源之一）
1) Redis
用途：
缓存
分布式锁
短期状态
限流计数
幂等键
可作为轻量队列（早期）
哪些模块用：
gateway（限流/会话缓存/幂等）
orchestrator（锁、状态缓存）
model-router（节点状态缓存）
worker-hub（任务短状态）
observer（临时计数）
1) RabbitMQ 优先）
用途：
任务异步投递
事件驱动解耦
执行结果回调事件
哪些模块用：
orchestrator（发任务、收事件）
model-router（发派发任务）
worker-hub / worker-*（消费执行任务，回发结果）
composer（消费合成任务）
4) 对象存储（S3/MinIO）
用途：
视频/音频/图片产物存储
中间产物（分镜图、音轨片段、参考图）
最终导出文件
哪些模块用：
worker-video/audio/lipsync（上传产物）
composer（读写）
gateway（签名 URL / 下载链接）
asset-knowledge（素材存储）
orchestrator（只存元数据，不存大文件）
✅ 不要把大文件塞数据库。
6) 日志与追踪（OpenTelemetry + Loki/ELK/Tempo/Jaeger 任选）
用途：
跨模块追踪一次任务从创建到导出
定位失败步骤和耗时热点
哪些模块用：
全部模块都应该接入（至少 gateway/orchestrator/router/worker）
✅ 早期可先简单日志，后面加 tracing。
7) 任务监控/指标（Prometheus + Grafana）
用途：
队列长度、GPU使用率、任务耗时、失败率
路由健康度、worker吞吐量
哪些模块用：
model-router（关键)
worker-hub / worker-*（关键）
orchestrator（关键）
observer（聚合展示）

## 容器规划
1) ainern2d-studio-api（一个 FastAPI 项目）
内部按模块分层，逻辑上保留你这些名字：
gateway（API入口）
orchestrator（流程推进）
entity_core
asset_knowledge（先直连 pgvector）
planner
model_router
observer（先记录日志/成本到DB）

2) ainern2d-worker-hub（一个 FastAPI + 队列消费者）
接收调度任务
按类型分发给具体 worker
状态回写
artifact 元数据登记
3) ainern2d-worker-runtime（可一个仓库多个 worker 进程）
video worker
audio worker
llm worker
lipsync worker
👉 这些通常不需要对外开放 HTTP，走 RabbitMQ/Redis Queue 更合适。

4) ainern2d-composer
5) ainern2d-studio-web(vue3用户操作界面)

ainern2d/
├── README.md
├── .env.example
├── docker-compose.yml                  # 开发环境总编排（核心）
├── docker-compose.worker.yml           # 可选：单独拉 worker 集群
├── docker-compose.observability.yml    # 可选：监控日志
├── Makefile
├── scripts/
│   ├── dev-up.sh
│   ├── dev-down.sh
│   ├── migrate.sh
│   ├── seed_rag.sh
│   └── init_storage.sh
│
├── infra/
│   ├── nginx/                          # 反向代理（可选）
│   │   └── nginx.conf
│   ├── postgres/
│   │   └── init.sql
│   ├── rabbitmq/
│   │   └── definitions.json
│   ├── redis/
│   └── grafana/
│       └── provisioning/
│
├── shared/                             # 跨服务共享代码（非常重要）
│   ├── pyproject.toml
│   └── ainern2d_shared/
│       ├── config/
│       │   ├── settings.py
│       │   └── enums.py
│       ├── schemas/                    # pydantic DTO
│       │   ├── task.py
│       │   ├── artifact.py
│       │   ├── timeline.py
│       │   └── events.py
│       ├── db/
│       │   ├── models.py               # 你现有 models.py 可逐步迁入
│       │   ├── session.py
│       │   └── repositories/
│       ├── queue/
│       │   ├── rabbitmq.py
│       │   ├── topics.py
│       │   └── message_contracts.py
│       ├── storage/
│       │   ├── s3.py
│       │   └── minio.py
│       ├── telemetry/
│       │   ├── logging.py
│       │   ├── metrics.py
│       │   └── tracing.py
│       └── utils/
│           ├── time.py
│           ├── idempotency.py
│           └── retry.py
│
├── apps/
│   ├── ainern2d-studio-api/            # FastAPI 项目 #1（推荐核心）
│   │   ├── Dockerfile
│   │   ├── pyproject.toml
│   │   ├── alembic.ini
│   │   ├── alembic/
│   │   └── app/
│   │       ├── main.py
│   │       ├── api/                    # gateway 职责
│   │       │   ├── deps.py
│   │       │   ├── middleware/
│   │       │   ├── v1/
│   │       │   │   ├── auth.py
│   │       │   │   ├── projects.py
│   │       │   │   ├── tasks.py
│   │       │   │   ├── timeline.py
│   │       │   │   ├── assets.py
│   │       │   │   └── regenerate.py
│   │       ├── modules/
│   │       │   ├── orchestrator/       # 逻辑模块，不一定独立服务
│   │       │   │   ├── service.py
│   │       │   │   ├── state_machine.py
│   │       │   │   ├── dag_engine.py
│   │       │   │   ├── recovery.py
│   │       │   │   └── event_log.py
│   │       │   ├── entity_core/
│   │       │   │   ├── extractor.py
│   │       │   │   ├── normalizer.py
│   │       │   │   ├── continuity.py
│   │       │   │   └── world_pack_builder.py
│   │       │   ├── asset_knowledge/
│   │       │   │   ├── ingest.py
│   │       │   │   ├── embedding.py
│   │       │   │   ├── retrieval.py
│   │       │   │   └── hybrid_search.py
│   │       │   ├── planner/
│   │       │   │   ├── creative_policy.py
│   │       │   │   ├── production_scheduler.py
│   │       │   │   ├── shot_plan.py
│   │       │   │   ├── timeline_plan.py
│   │       │   │   └── budget_degrade.py
│   │       │   ├── model_router/
│   │       │   │   ├── router.py
│   │       │   │   ├── provider_registry.py
│   │       │   │   ├── health.py
│   │       │   │   └── dispatch_decision.py
│   │       │   └── observer/
│   │       │       ├── cost_meter.py
│   │       │       ├── audit.py
│   │       │       └── metrics_writer.py
│   │       ├── services/               # 应用服务层（组合 modules）
│   │       ├── workers/                # 可放后台消费者（初期）
│   │       └── tests/
│   │
│   ├── ainern2d-worker-hub/            # FastAPI 项目 #2
│   │   ├── Dockerfile
│   │   ├── pyproject.toml
│   │   └── app/
│   │       ├── main.py
│   │       ├── api/
│   │       │   └── v1/
│   │       │       ├── dispatch.py
│   │       │       ├── callbacks.py
│   │       │       └── telemetry.py
│   │       ├── consumers/
│   │       │   ├── dispatch_consumer.py
│   │       │   └── result_consumer.py
│   │       ├── dispatcher/
│   │       │   ├── hub.py
│   │       │   ├── routing_table.py
│   │       │   └── node_registry.py
│   │       ├── adapters/
│   │       │   ├── worker_video_adapter.py
│   │       │   ├── worker_audio_adapter.py
│   │       │   ├── worker_llm_adapter.py
│   │       │   └── worker_lipsync_adapter.py
│   │       └── tests/
│   │
│   ├── ainern2d-worker-runtime/        # 一个仓库，多个 worker 入口
│   │   ├── Dockerfile
│   │   ├── pyproject.toml
│   │   └── app/
│   │       ├── main_video.py
│   │       ├── main_audio.py
│   │       ├── main_llm.py
│   │       ├── main_lipsync.py
│   │       ├── common/
│   │       │   ├── base_worker.py
│   │       │   ├── job_loop.py
│   │       │   └── result_reporter.py
│   │       ├── video/
│   │       │   ├── comfyui_client.py
│   │       │   ├── pipeline_i2v.py
│   │       │   ├── pipeline_v2v.py
│   │       │   └── postprocess.py
│   │       ├── audio/
│   │       │   ├── tts.py
│   │       │   ├── bgm.py
│   │       │   ├── sfx.py
│   │       │   └── align.py
│   │       ├── llm/
│   │       │   ├── provider_openai.py
│   │       │   ├── provider_deepseek.py
│   │       │   ├── provider_qwen.py
│   │       │   └── tasks/
│   │       │       ├── extract.py
│   │       │       ├── translate.py
│   │       │       └── prompt_gen.py
│   │       └── lipsync/
│   │           ├── engine.py
│   │           └── align_report.py
│   │
│   ├── ainern2d-composer/              # FastAPI 项目 #3（可后拆）
│   │   ├── Dockerfile
│   │   ├── pyproject.toml
│   │   └── app/
│   │       ├── main.py
│   │       ├── api/v1/compose.py
│   │       ├── timeline/
│   │       │   ├── assembler.py
│   │       │   ├── validator.py
│   │       │   └── exporter.py
│   │       ├── ffmpeg/
│   │       │   ├── commands.py
│   │       │   └── runners.py
│   │       └── tests/
│   │
│   └── ainern2d-studio-web/            # Vue3 前端
│       ├── package.json
│       ├── vite.config.ts
│       └── src/
│           ├── pages/
│           ├── modules/
│           │   ├── tasks/
│           │   ├── timeline/
│           │   ├── assets/
│           │   └── preview/
│           ├── components/
│           ├── stores/
│           ├── api/
│           └── types/
│
└── docs/
    ├── architecture/
    │   ├── system-overview.md
    │   ├── module-boundaries.md
    │   ├── event-contracts.md
    │   └── deployment-topology.md
    ├── runbooks/
    └── decisions/

## 决策A实施（2026-02）

### 决策
- 共享模型与服务私有表并行规划。
- 共享字段标准优先落地，再做服务映射。

### 共享字段标准（必须一致）
- tenant_id
- project_id
- trace_id
- correlation_id
- idempotency_key
- error_code
- version
- created_at / updated_at / deleted_at

### 实施文档入口
- Agent启动入口：`START_HERE_FOR_AGENTS.md`
- 契约：`ainer_contracts.md`
- 事件：`ainer_event_types.md`
- 错误码：`ainer_error_code.md`
- 系统总览：`code/docs/architecture/system-overview.md`
- 模块边界：`code/docs/architecture/module-boundaries.md`
- 事件契约：`code/docs/architecture/event-contracts.md`
- 服务API契约：`code/docs/architecture/service-api-contracts.md`
- 队列与重试策略：`code/docs/architecture/queue-topics-and-retry-policy.md`
- Stage权威枚举：`code/docs/architecture/stage-enum-authority.md`
- Studio接口映射：`code/docs/architecture/studio-web-api-mapping.md`
- Skill机器模板：`code/docs/architecture/skill-schema-template.md`
- 字段映射清单：`code/docs/architecture/shared-field-mapping-matrix.md`
- 理想模型蓝图：`code/docs/architecture/ideal-db-model-blueprint.md`
- Alembic拆解：`code/docs/runbooks/alembic-migration-plan-p0-p2.md`
- 第二轮实施清单：`code/docs/runbooks/round2-implementation-checklist.md`
- 实施状态账本：`code/docs/runbooks/implementation-status-ledger.md`
- CI门禁执行规范：`code/docs/runbooks/ci-gate-execution-spec.md`
- Agent执行顺序：`code/docs/runbooks/agent-implementation-playbook.md`
- Agent数据模型落地指南：`code/docs/architecture/agent-data-model-guideline.md`
- Agent编码框架与代码生成模板指南：`code/docs/architecture/agent-coding-framework-guideline.md`
- 部署拓扑：`code/docs/architecture/deployment-topology.md`
- E2E交接验收：`code/docs/runbooks/e2e-handoff-test-matrix.md`
- Skill线上部署：`code/docs/runbooks/skill-online-deployment.md`
- P1治理计划：`code/docs/runbooks/p1-ops-governance-plan.md`
- 14~20接入说明：`README_14_20_INTEGRATION_GUIDE.md`

### 闭环主流程
- 登录鉴权 -> 项目与内容输入 -> 实体抽取与规划 -> 路由与执行 -> 合成导出 -> 观测回流 -> 人工修订重生成。

### 01~13职责边界与调用主链（统一版）

#### 调用主链（权威）
- `01 gateway`：接入与查询入口，仅做鉴权/校验/幂等，不做业务编排。
- `02 orchestrator`：流程状态机权威，负责阶段推进、重试/补偿、事件驱动。
- `03 entity-core`：实体抽取与归一化，输出世界观与实体包。
- `04 asset-knowledge`：素材与知识检索，输出候选资产与约束元数据。
- `05 planner`：场景/镜头/时序计划权威，产出可执行任务图。
- `06 model-router`：模型与资源决策权威，输出执行路由决策。
- `07 worker-hub`：任务分发与状态回写中枢，管理 worker 生命周期。
- `08/09/10/11 workers`：分别执行视频/音频/LLM/lipsync 原子任务。
- `12 composer`：最终合成与导出权威，产出发布级 artifact。
- `13 observer`：观测、审计、成本与SLA权威，不改写业务状态。

#### 边界约束（必须遵守）
- 上游不得绕过 `02` 直接调度 worker。
- `05` 只产计划，不直接落执行状态。
- `06` 只做路由决策，不直接编排业务流。
- `07` 只做执行控制，不修改业务语义数据。
- `13` 只做观测与审计，不反向改写运行态。

#### 事件归属（唯一权威）
- 流程状态事件：`02 orchestrator`。
- 路由决策事件：`06 model-router`。
- 执行回执事件：`07 worker-hub` 与各 worker。
- 合成发布事件：`12 composer`。
- 告警观测事件：`13 observer`。